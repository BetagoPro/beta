<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" >
<head>
    <meta charset="UTF-8">
    <title>사이트 제목</title>
    <!--공통으로 쓰이는 CSS 및  -->
    <div th:replace="~{common/fragments/config :: configFragment}"></div>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 데이터 요소 가져오기
        var dayValues = document.querySelectorAll('.data-value#dayValue');
        var totalSellValues = document.querySelectorAll('.data-value#totalSellValue');
        var totalSalesValues = document.querySelectorAll('.data-value#totalSalesValue');

        // 데이터 배열 초기화
        var years = [];
        var sales = [];
        var transactions = [];

        // 데이터 추출
        for (var i = 0; i < dayValues.length; i++) {
            years.push(dayValues[i].value);
            sales.push(totalSellValues[i].value);
            transactions.push(totalSalesValues[i].value);
        }

        // Google Charts 로드
        google.charts.load('current', { 'packages': ['bar'] });
        google.charts.setOnLoadCallback(drawChart);

        // 차트 그리기 함수
        function drawChart() {
            var data = google.visualization.arrayToDataTable([
                ['년도', '매출액', '건수']
            ]);

            var totalSales = 0; // 매출액 총합 변수 초기화
            var totalTransactions = 0; // 건수 총합 변수 초기화

            for (var i = 0; i < years.length; i++) {
                var formattedSales = parseInt(sales[i]).toLocaleString(); // sales 값을 콤마가 있는 형태로 변환
                data.addRow([years[i], formattedSales + '원', transactions[i] + '건']);

                totalSales += parseInt(sales[i]); // 매출액 누적 합산
                totalTransactions += parseInt(transactions[i]); // 건수 누적 합산
            }

            document.querySelector('.info-container h3:nth-child(1) span').textContent = totalSales.toLocaleString(); // 매출액 총합 출력
            document.querySelector('.info-container h3:nth-child(2) span').textContent = totalTransactions.toLocaleString(); // 건수 총합 출력

            var options = {
                chart: {
                    title: '',
                    subtitle: ''
                },
                series: {
                    0: { axis: '건수', annotations: { stemColor: 'none' } }
                },
                vAxes: {
                    0: {
                        gridlines: {
                            count: 0
                        }
                    },
                    1: {
                        gridlines: {
                            count: 1
                        }
                    }
                }
            };

            var chart = new google.charts.Bar(document.getElementById('columnchart_material'));
            chart.draw(data, google.charts.Bar.convertOptions(options));
        }

        // 검색 버튼 이벤트 리스너 추가
        var searchBtn = document.querySelector(".search-btn");
        searchBtn.addEventListener("click", function () {
            var intervalRadio = document.querySelector('input[name="interval"]:checked');
            var startDateSingle = document.getElementById('startdate_single').value;
            var startDate = document.getElementById('startdate').value;
            var endDate = document.getElementById('enddate').value;

            var testURL = '/pay/test?pay_date=' + encodeURIComponent(startDateSingle);

            if (intervalRadio && intervalRadio.value === 'month') {
                // 월단위 선택 시, startDate와 endDate를 URL에 추가
                testURL = '/pay/test?pay_date=' + encodeURIComponent(startDate) + '&pay_enddate=' + encodeURIComponent(endDate);
            }

            window.location.href = testURL;
        });

        // 라디오 버튼 요소 가져오기
        var dayRadio = document.querySelector('input[value="day"]');
        var monthRadio = document.querySelector('input[value="month"]');

        // 날짜 입력 요소 가져오기
        var dateRange = document.getElementById('daterange');
        var startDateSingle = document.getElementById('startdate_single');
        var startDate = document.getElementById('startdate'); // startdate 입력 요소 가져오기
        var endDate = document.getElementById('enddate');     // enddate 입력 요소 가져오기

        // "일단위" 라디오 버튼에 대한 이벤트 리스너 추가
        dayRadio.addEventListener("change", function () {
            dateRange.style.display = 'none'; // 날짜 범위 숨기기
            startDateSingle.style.display = ''; // 단일 날짜 표시
        });

        // "월단위" 라디오 버튼에 대한 이벤트 리스너 추가
        monthRadio.addEventListener("change", function () {
            dateRange.style.display = ''; // 날짜 범위 표시
            startDateSingle.style.display = 'none'; // 단일 날짜 숨기기
        });

        // startdate 값이 변경될 때 enddate의 min 및 max 값을 설정
        startDate.addEventListener("input", function () {
            endDate.min = startDate.value;

            // 년도와 월을 분리
            var parts = startDate.value.split('-');
            var year = parseInt(parts[0]);
            var month = parseInt(parts[1]);

            // 년도를 1년 증가시키고 해당 날짜를 max로 설정
            var maxDate = new Date(year + 1, month - 1); // month는 0부터 시작하므로 -1
            var maxYear = maxDate.getFullYear();
            var maxMonth = String(maxDate.getMonth() + 1).padStart(2, '0'); // 월도 0부터 시작하므로 +1, 두 자리 숫자로 포매팅

            endDate.max = `${maxYear}-${maxMonth}`;
        });

        // 페이지 로드 시 초기 설정
        if (dayRadio.checked) {
            dateRange.style.display = 'none';
            startDateSingle.style.display = '';
        } else if (monthRadio.checked) {
            dateRange.style.display = '';
            startDateSingle.style.display = 'none';
        }
    });
</script>

<style>
.date-container, .info-container{
    display: flex;
    justify-content: flex-start;
    gap: 10px;
    padding-left: 45px;
    margin-bottom: 20px;
}
.info-container{
    display: flex;
    justify-content: space-between;
}

.date-container > div{
    margin: 0;
    display: flex;
    align-items: center;
}
.info-container > div{
    margin: 0;
}
.info{
    display: flex;
    gap: 20px;
}
.search-btn,.chart-btn{
    height: 40px;
    background: #fff;
    padding: 20px;
    font-size: 18px;
    border: none;
    font-weight: 400;
    border-radius: 8px;
    line-height: 0;
    cursor: pointer;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
}
.search-btn:hover{
    background: #F4D96E;
}
.chart-btn:hover{
    background: #F4D96E;
}
</style>
<body>
<div th:replace="~{common/fragments/header :: headerFragment}"></div>
<div class="content">
    <div th:replace="~{common/fragments/default_sidebar :: default_sidebarFragment}"></div>
    <div class="content-wrap">
        <div class="chart-container">
            <div class="date-container">
                <div>
                    <span>조회 기간</span>
                    <div id="daterange" style="display: none;">
                        <input type="month" id="startdate">
                        <span>~</span>
                        <input type="month" id="enddate">
                    </div>
                    <input type="month" id="startdate_single">
                </div>
                <div>
                    <span>일단위</span>
                    <input type="radio" name="interval" value="day" checked>
                    <span>월단위</span>
                    <input type="radio" name= "interval" value= "month">
                </div>
            </div>
            </div>
            <div class="info-container">
                <div class="info">
                <h3>총 매출액:<span></span>원</h3>
                <h3>건수:<span></span>개</h3>
                </div>
                <div class="button">
                    <input type="button" class="search-btn" value="조회">
                    <input type="button" class="chart-btn" value="목록 보기">
                </div>
            </div>
        <h3 style="margin-bottom: 10px;">현재 조회 기간 : <span th:text="${#dates.format(comment, 'yyyy-MM')} + (${comment2 != null ? '~' + #dates.format(comment2, 'yyyy-MM') : ''})"></span>
        </h3>
        <div id="columnchart_material" style="width: 100%; min-width: 25%; height: 500px;"></div>
        </div>
    </div>
<input type="hidden" th:each="dayList : ${dayList}" th:value="${dayList.day}" id="dayValue" class="data-value">
<input type="hidden" th:each="dayList : ${dayList}" th:value="${dayList.total_sell}" id="totalSellValue" class="data-value">
<input type="hidden" th:each="dayList : ${dayList}" th:value="${dayList.total_sales}" id="totalSalesValue" class="data-value">
<div th:replace="~{common/fragments/footer :: footerFragment}"></div>
</body>
</html>
