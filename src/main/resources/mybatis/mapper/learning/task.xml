<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bnw.beta.domain.learning.dao.TaskDAO">

    <!--교육자 숙제 관련 쿼리문//////////////////////////////////////////////////-->
    <!--숙제 생성-->
    <insert id="createTask" parameterType="TaskDTO">
        <![CDATA[
        INSERT INTO TASK (task_title, task_content, task_chapter, task_deadline, task_regdate, member_id)
        VALUES (#{task_title}, #{task_content}, #{task_chapter},#{task_deadline}, now(), #{member_id});
        ]]>
    </insert>

    <!--숙제 전송-->

    <!--전송한 숙제 조회-->
    <select id="sendTaskList" parameterType="map" resultType="TaskDTO">
        <![CDATA[
        SELECT t.task_no, s.task_senddate, MAX(t.task_title) AS task_title,
                                                                    MAX(t.task_content) AS task_content, MAX(t.task_chapter) AS task_chapter,
                                                                    MAX(t.task_regdate) AS task_regdate, MAX(t.task_deadline) AS task_deadline,
                                                                    MAX(t.member_id) AS member_id, MAX(s.tasksend_no) AS tasksend_no
        FROM TASK t
        JOIN tasksend s ON t.task_no = s.task_no
        WHERE t.member_id = #{member_id}
        GROUP BY t.task_no, s.task_senddate
        ORDER BY MAX(t.task_regdate) DESC
        LIMIT #{page}, #{size};
        ]]>
    </select>

    <!--전송한 숙제 갯수 조회-->
    <select id="sendTaskListCount" parameterType="String" resultType="Integer">
        <![CDATA[
        SELECT COUNT(*) AS record_count
        FROM (
            SELECT t.task_no, s.task_senddate
            FROM TASK t
            JOIN tasksend s ON t.task_no = s.task_no
            WHERE t.member_id = #{member_id}
            GROUP BY t.task_no, s.task_senddate
        ) AS subquery;
        ]]>
    </select>

    <!--숙제 평가-->
    <update id="evaluationTask" parameterType="String">
        <![CDATA[
        UPDATE tasksend SET task_state = '평가완료'
        WHERE tasksend_no = #{tasksend_no};
        ]]>
    </update>

    <update id="insertEvaluation" parameterType="TaskDTO">
        <![CDATA[
        UPDATE tasksubmit
        SET tasksubmit_eval = #{tasksubmit_eval}, tasksubmit_comment = #{tasksubmit_comment}
        WHERE tasksubmit_no = #{tasksubmit_no};
        ]]>
    </update>

    <!--수강생 숙제 관련 쿼리문//////////////////////////////////////////////////-->
    <!--전송된 숙제 조회-->
    <select id="selectTaskById" parameterType="Integer" resultType="TaskSendDTO">
        <![CDATA[
        SELECT ts.tasksend_no, t.task_no, t.task_title, t.task_content, t.task_chapter, t.task_deadline, ts.task_state, m.member_name, g.game_title
        FROM tasksend AS ts
        JOIN task AS t
        ON ts.task_no = t.task_no
        JOIN  member AS m
        ON ts.member_id = m.member_id
        JOIN studygroup AS sg
        ON ts.group_no = sg.group_no
        JOIN game AS g ON sg.game_no = g.game_no
        WHERE ts.member_no = #{member_no}
        AND (ts.task_state = '미작성' OR ts.task_state = '작성중')
        ORDER BY t.task_regdate desc;
        ]]>
    </select>

   <!-- 숙제 번호로 정보 조회 -->
   <select id="selectTaskByNo" parameterType="TaskSendDTO" resultType="TaskSendDTO">
        <![CDATA[
        SELECT ts.tasksend_no, t.task_no, t.task_title, t.task_content, t.task_chapter, t.task_deadline, ts.task_state, m.member_name, g.game_title
        FROM tasksend AS ts
        JOIN task AS t ON ts.task_no = t.task_no
        JOIN member AS m ON ts.member_id = m.member_id
        JOIN studygroup AS sg ON ts.group_no = sg.group_no
        JOIN game AS g ON sg.game_no = g.game_no
        WHERE ts.tasksend_no = #{tasksend_no}
        AND ts.member_no = #{member_no};
        ]]>
    </select>

    <!--숙제 작성하기-->
    <insert id="wirteTask" parameterType="TaskSubmitDTO">
        <![CDATA[
        INSERT INTO tasksubmit (tasksubmit_chapter, tasksubmit_content, tasksubmit_add, tasksubmit_regdate, tasksend_no, task_no, member_id)
        VALUES (#{tasksubmit_chapter}, #{tasksubmit_content}, #{tasksubmit_add}, now(), #{tasksend_no}, #{task_no}, #{member_id});
        ]]>
    </insert>

    <!--숙제 수정페이지-->
    <select id="modifyTask" parameterType="TaskSubmitDTO" resultType="TaskSubmitDTO">
        <![CDATA[
        SELECT t.task_title, t.task_content, t.task_deadline, ts.task_state, m.member_name, ts.member_no, g.game_title, sub.*
        FROM tasksend AS ts
        JOIN task AS t
        ON ts.task_no = t.task_no
        JOIN tasksubmit AS sub
        ON ts.tasksend_no = sub.tasksend_no
        JOIN  member AS m
        ON ts.member_id = m.member_id
        JOIN studygroup AS sg
        ON ts.group_no = sg.group_no
        JOIN game AS g ON sg.game_no = g.game_no
        WHERE ts.tasksend_no = #{tasksend_no}
        AND ts.member_no = #{member_no};
        ]]>
    </select>

    <!--작성 숙제 수정하기-->
    <update id="ModifySubmitTask" parameterType="TaskSubmitDTO">
        <![CDATA[
        UPDATE tasksubmit
        SET tasksubmit_chapter = #{tasksubmit_chapter}, tasksubmit_content = #{tasksubmit_content}, tasksubmit_add = #{tasksubmit_add}
        WHERE tasksend_no = #{tasksend_no};
        ]]>
    </update>

    <!--작성 숙제 저장-->
    <update id="saveTask" parameterType="Integer">
        <![CDATA[
        UPDATE tasksend SET task_state = '작성중'
        WHERE tasksend_no = #{tasksend_no};
        ]]>
    </update>

    <!--숙제 제출-->
    <update id="submitTask" parameterType="java.util.List">
        <![CDATA[
        UPDATE tasksend AS ts
        JOIN tasksubmit sub ON ts.tasksend_no = sub.tasksend_no
        SET ts.task_state = '제출완료', sub.tasksubmit_regdate = now()
        WHERE ts.tasksend_no IN
        ]]>
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <!--제출 숙제 조회하기-->
    <select id="selectSubmitTask" parameterType="Integer" resultType="TaskSubmitDTO">
        <![CDATA[
        SELECT t.task_title, t.task_content, t.task_deadline, ts.task_state, m.member_name, ts.member_no, g.game_title
        FROM tasksend AS ts
        JOIN task AS t
        ON ts.task_no = t.task_no
        JOIN  member AS m
        ON ts.member_id = m.member_id
        JOIN studygroup AS sg
        ON ts.group_no = sg.group_no
        JOIN game AS g ON sg.game_no = g.game_no
        WHERE ts.member_no = #{member_no}
        AND (ts.task_state = '제출완료' OR ts.task_state = '평가완료');
        ]]>
    </select>

    <!--평가 완료된 숙제 조회-->
    <select id="selectSubmitTaskByNo" parameterType="Integer" resultType="TaskSubmitDTO">
        <![CDATA[
        SELECT ts.tasksend_no, t.task_no, t.task_title, t.task_content, t.task_chapter, t.task_deadline, ts.task_state, m.member_name, g.game_title, sub.*
        FROM tasksend AS ts
        JOIN task AS t ON ts.task_no = t.task_no
        JOIN tasksubmit AS sub ON ts.tasksend_no = sub.tasksend_no
        JOIN member AS m ON ts.member_id = m.member_id
        JOIN studygroup AS sg ON ts.group_no = sg.group_no
        JOIN game AS g ON sg.game_no = g.game_no
        WHERE ts.tasksend_no = #{tasksend_no};
        ]]>
    </select>

</mapper>