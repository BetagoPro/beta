<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bnw.beta.domain.learning.dao.GroupDAO">

    <!-- 그룹등록 가능한 게임콘텐츠 Cnt -->
    <select id="groupAddListCnt" resultType="int">
        <![CDATA[
        SELECT COUNT(*) AS count
        FROM (
            SELECT p.pay_no, g.game_no, g.game_title, g.game_level, g.game_total, fg.filegame_name,
            m.member_name, SUM(s.group_nowcnt) AS group_nowcnt,
            MAX(p.pay_date) AS pay_date, MAX(p.pay_enddate) AS pay_enddate
            FROM game g
            LEFT JOIN studygroup s ON g.game_no = s.game_no
            LEFT JOIN pay p ON g.game_no = p.game_no
            LEFT JOIN filegame fg ON g.game_no = fg.game_no
            JOIN member m ON p.member_id = m.member_id
            WHERE p.member_id = #{member_id}
            ]]>
            <if test="game_title != null and game_title != ''">
            <![CDATA[
                AND g.game_title = #{game_title}
                AND CURDATE() <= (
                    SELECT MAX(pay_enddate)
                    FROM pay
                    WHERE game_no = g.game_no
                )
            ]]>
            </if>
        <![CDATA[
            GROUP BY g.game_no, m.member_name, fg.filegame_name, p.pay_no
            HAVING SUM(s.group_nowcnt) < g.game_total OR SUM(s.group_nowcnt) IS NULL
        ) AS subquery;
        ]]>
    </select>

    <!-- 게임 콘텐츠 title 조회 그룹인원 초과된건 조회안되게 학원가서 수정 -->
    <select id="selectGameTitle" resultType="GroupDTO">
        <![CDATA[
        SELECT DISTINCT g.game_title
        FROM game g
        LEFT JOIN studygroup s ON g.game_no = s.game_no
        LEFT JOIN pay p ON g.game_no = p.game_no
        LEFT JOIN filegame fg ON g.game_no = fg.game_no
        JOIN member m ON p.member_id = m.member_id
        WHERE p.member_id = #{member_id}
          AND CURDATE() <= (
            SELECT MAX(pay_enddate)
            FROM pay
            WHERE game_no = g.game_no
          )
        GROUP BY g.game_title
        HAVING SUM(s.group_nowcnt) < SUM(g.game_total) OR SUM(s.group_nowcnt) IS NULL
        ORDER BY g.game_title ASC;
        ]]>
    </select>

    <!-- 그룹등록 가능한 게임콘텐츠 조회(무한 스크롤) -->
    <select id="groupAddList" parameterType="GroupDTO" resultType="GroupDTO">
        <![CDATA[
        SELECT p.pay_no, g.game_no, g.game_title, g.game_level, g.game_total, fg.filegame_name,
        m.member_name, SUM(s.group_nowcnt) AS group_nowcnt,
        MAX(p.pay_date) AS pay_date, MAX(p.pay_enddate) AS pay_enddate
        FROM game g
        LEFT JOIN studygroup s ON g.game_no = s.game_no
        LEFT JOIN pay p ON g.game_no = p.game_no
        LEFT JOIN filegame fg ON g.game_no = fg.game_no
        JOIN member m ON p.member_id = m.member_id
        WHERE p.member_id = #{member_id}
        ]]>
        <if test="game_title != null and game_title != ''">
        <![CDATA[
            AND g.game_title = #{game_title}
            AND CURDATE() <= (
                SELECT MAX(pay_enddate)
                FROM pay
                WHERE game_no = g.game_no
            )
            ]]>
        </if>
        <![CDATA[
        GROUP BY g.game_no, m.member_name, fg.filegame_name, p.pay_no
        HAVING SUM(s.group_nowcnt) < g.game_total OR SUM(s.group_nowcnt) IS NULL
        ORDER BY g.game_no ASC
        LIMIT #{LIMIT} OFFSET #{OFFSET};
        ]]>
    </select>

    <!-- 그룹 등록을 위한 게임 콘텐츠 정보 불러오기 -->
    <select id="gameGroupInfo" parameterType="Integer" resultType="GroupDTO">
        <![CDATA[
        SELECT g.game_no, g.game_title, g.game_total, IFNULL(SUM(sg.group_cnt), 0) AS group_cnt,
               p.pay_date, p.pay_enddate
        FROM game g
        LEFT JOIN studygroup sg ON g.game_no = sg.game_no
        LEFT JOIN pay p ON g.game_no = p.game_no
        WHERE p.pay_no = #{pay_no};
        ]]>
    </select>

    <!-- 학습 그룹 등록(상세) -->
    <insert id="insertGroup" parameterType="GroupDTO">
        INSERT INTO studygroup (game_no, group_name, group_intro, member_id, group_cnt, group_startdate, group_enddate)
        VALUES (#{game_no}, #{group_name}, #{group_intro}, #{member_id}, #{group_cnt}, #{group_startdate}, #{group_enddate});
    </insert>

    <!-- 학습 그룹 조회 목록 불러오기 -->
    <select id="groupListSelect" parameterType="GroupDTO" resultType="GroupDTO">
        <![CDATA[
        SELECT sg.group_no, sg.group_name, sg.group_startdate, sg.group_enddate, sg.group_cnt, sg.group_nowcnt, g.game_title
        FROM studygroup AS sg
        JOIN game AS g ON sg.game_no = g.game_no
        WHERE
            sg.member_id = #{member_id}
        ]]>

        <if test="group_name != null and group_name != ''">
            AND sg.group_name = #{group_name}
        </if>
    </select>

    <!-- 학습 그룹 name 조회 -->
    <select id="selectGroupName" parameterType="GroupDTO" resultType="GroupDTO">
        <![CDATA[
        SELECT group_name, group_no
        FROM studygroup
        WHERE member_id = #{member_id}
        AND group_enddate >= CURDATE()
        ]]>
    </select>

    <!-- 학습 그룹 상세 조회 -->
    <select id="selectGroupDetail" parameterType="GroupDTO" resultType="GroupDTO">
        <![CDATA[
        SELECT
        m.member_name, m.member_phone, m.member_email, m.join_date,
        g.group_name, g.group_cnt, g.group_nowcnt,
        ga.game_title
        FROM
        groupmember AS gm
        JOIN
        member AS m ON gm.member_no = m.member_no
        JOIN
        studygroup AS g ON gm.group_no = g.group_no
        JOIN
        game AS ga ON gm.game_no = ga.game_no
        WHERE
        gm.group_no = #{group_no}
        ]]>
        <if test="group_name != null and group_name != ''">
            AND g.group_name = #{group_name}
        </if>
    </select>

    <!-- 학습 그룹 삭제 -->
    <delete id="deleteGroup" parameterType="java.util.List">
        <![CDATA[
        DELETE FROM studygroup
        WHERE group_no IN
        ]]>
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
        #{item}
        </foreach>
    </delete>

    <!-- 그룹 학생 가입승인 목록 -->
    <select id="selectGroupApprove" parameterType="map" resultType="GroupDTO">
        <![CDATA[
        SELECT sg.group_name, sg.group_cnt, sg.group_nowcnt,
               gm.gm_no, gm.group_no, gm.member_no, gm.approve_date,
               m.member_name, m.member_phone
        FROM studygroup AS sg
        JOIN groupmember AS gm ON sg.group_no = gm.group_no
        JOIN member AS m ON gm.member_no = m.member_no
        WHERE sg.group_nowcnt < sg.group_cnt
        AND gm.approve_state = '미승인'
        ]]>
        <if test="member_id != null and member_id != ''">
            AND sg.member_id = #{member_id}
        </if>
        <if test="group_no != null and group_no != ''">
            AND sg.group_no = #{group_no}
        </if>
        <if test="group_no == null">
            AND 1 = 0
        </if>
        <![CDATA[
        ORDER BY gm.approve_date ASC
        LIMIT #{page}, #{size};
        ]]>
    </select>

    <!-- 그룹 학생 가입승인 목록 갯수 -->
    <select id="selectGroupApproveCount" parameterType="map" resultType="Integer">
        <![CDATA[
        SELECT COUNT(*) AS record_count
        FROM groupmember gm
        JOIN member m ON gm.member_no = m.member_no
        JOIN studygroup sg ON gm.group_no = sg.group_no
        JOIN game g ON gm.game_no = g.game_no
        WHERE sg.member_id = #{member_id}
        AND gm.approve_state = '미승인'
        ]]>
        <if test="group_no != null and group_no != ''">
            AND sg.group_no = #{group_no}
        </if>
    </select>

    <!-- 그룹 학생 가입승인 정보 -->
    <select id="selectGroupInfo" parameterType="Integer" resultType="GroupDTO">
        <if test="group_no != null and group_no != ''">
            <![CDATA[
            SELECT sg.group_no, sg.group_name, sg.group_cnt, sg.group_nowcnt, g.game_title,
            COUNT(CASE WHEN gm.approve_state = '승인' THEN 1 END) AS member_count
            FROM studygroup sg
            JOIN game g ON sg.game_no = g.game_no
            LEFT JOIN groupmember gm ON sg.group_no = gm.group_no
            WHERE sg.group_no = #{group_no}
            GROUP BY sg.group_no;
            ]]>
        </if>
    </select>

    <update id="updateGroupMembber">
        UPDATE groupmember
        SET approve_state = #{state}
        WHERE gm_no IN
        <foreach item="item" index="index" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
    </update>

    <!--///////////////////학습자/////////////////// -->

    <!-- 학습 그룹 가입 신청 목록 -->
    <select id="selectJoinGroup" resultType="GroupDTO">
        <![CDATA[
        SELECT sg.*, m.member_no, m.member_name
        FROM studygroup sg
        JOIN member m ON sg.member_id = m.member_id
        LEFT JOIN groupmember gm ON sg.group_no = gm.group_no AND gm.member_no = #{member_no}
        WHERE sg.group_nowcnt < sg.group_cnt
        AND gm.member_no IS NULL
        ]]>
        <if test="group_name != null and group_name != ''">
            AND sg.group_name = #{group_name}
        </if>
        <if test="member_name != null and member_name != ''">
            AND m.member_name = #{member_name}
        </if>
        <![CDATA[
        ORDER BY sg.group_enddate
        LIMIT #{LIMIT} OFFSET #{OFFSET};
        ]]>
    </select>

    <!-- 그룹 가입신청 가능한 목록 갯수 -->
    <select id="joinGroupCount" parameterType="map" resultType="Integer">
        <![CDATA[
        SELECT count(*)
        FROM studygroup sg
        LEFT JOIN groupmember gm ON sg.group_no = gm.group_no AND gm.member_no = #{member_no}
        LEFT JOIN member m ON gm.member_no = m.member_no
        WHERE sg.group_nowcnt < sg.group_cnt
        AND gm.member_no IS NULL
        ]]>
        <if test="group_name != null and group_name != ''">
            AND sg.group_name = #{group_name}
        </if>
        <if test="member_name != null and member_name != ''">
            AND m.member_name = #{member_name}
        </if>
    </select>

    <!-- 그룹명 목록 불러오기 -->
    <select id="selectGroupTitle" resultType="GroupDTO">
        <![CDATA[
        SELECT DISTINCT group_name
        FROM studygroup
        WHERE group_nowcnt < group_cnt;
        ]]>
    </select>

    <!-- 교육자명 불러오기 -->
    <select id="selectEducatorName" resultType="GroupDTO">
        <![CDATA[
        SELECT DISTINCT m.member_name, m.member_no
        FROM studygroup AS sg
        JOIN member AS m ON m.member_id = sg.member_id
        WHERE sg.group_nowcnt < sg.group_cnt;
        ]]>
    </select>

    <!-- 그룹 신청 가능 실시간 체크 -->
    <select id="checkJoin" parameterType="Integer" resultType="Integer">
        <![CDATA[
        SELECT group_no
        FROM studygroup
        WHERE (group_cnt - group_nowcnt) <> 0
        ]]>
        <if test="group_no != null and group_no != ''">
            AND group_no = #{group_no}
        </if>
    </select>

    <!-- 학생 그룹 가입신청 Insert -->
    <insert id="insertGroupJoin" parameterType="GroupDTO">
        <![CDATA[
        INSERT INTO groupmember (member_no, group_no, game_no)
        VALUES (#{member_no}, #{group_no}, #{game_no});
        ]]>
    </insert>

    <!-- 학생 그룹 현재인원 Update -->
    <update id="updateGroupJoin">
        <![CDATA[
        UPDATE studygroup
        SET group_nowcnt = group_nowcnt + #{num}
        WHERE group_no = #{group_no};
        ]]>
    </update>

    <!-- 가입신청 내역 목록 -->
    <select id="myjoinList" resultType="GroupDTO">
        <![CDATA[
        SELECT
        gm.approve_date,
        g.game_no, g.game_title, g.game_total, g.game_level, g.game_no,
        sg.group_no, sg.group_name, sg.group_intro, sg.group_cnt, sg.group_nowcnt, sg.group_startdate, sg.group_enddate,
        fg.filegame_name
        FROM
            groupmember gm
        JOIN
            game g ON gm.game_no = g.game_no
        JOIN
            studygroup sg ON gm.group_no = sg.group_no
        LEFT JOIN
        filegame fg ON gm.game_no = fg.game_no
        ]]>
        <if test = "member_name != null and member_name != ''">
        JOIN
        member m ON g.member_name = #{member_name}
        </if>
        WHERE m.member_no = #{member_no}
        <if test="group_name != null and group_name != ''">
            AND sg.group_name = #{group_name}
        </if>
        <![CDATA[
        ORDER BY gm.approve_date DESC
        LIMIT #{LIMIT} OFFSET #{OFFSET};
        ]]>
    </select>

    <!-- 가입신청 내역 목록 갯수 -->
    <select id="myjoinListCount" resultType="Integer">
        <![CDATA[
        SELECT COUNT(*)
        FROM
            groupmember gm
        JOIN
            game g ON gm.game_no = g.game_no
        JOIN
            studygroup sg ON gm.group_no = sg.group_no
        LEFT JOIN
        filegame fg ON gm.game_no = fg.game_no
        WHERE m.member_no = #{member_no}
        ]]>
        <if test = "member_name != null and member_name != ''">
            JOIN
            member m ON g.member_name = #{member_name}
        </if>
        WHERE m.member_no = #{member_no}
        <if test="group_name != null and group_name != ''">
            AND sg.group_name = #{group_name}
        </if>
    </select>

    <!-- 가입내역 그룹명 목록 -->
    <select id="myjoinListTitle" resultType="GroupDTO">
        <![CDATA[
        SELECT g.game_title
        FROM
            groupmember gm
        JOIN
            game g ON gm.game_no = g.game_no
        JOIN
            studygroup sg ON gm.group_no = sg.group_no
        LEFT JOIN
        filegame fg ON gm.game_no = fg.game_no
        WHERE gm.member_no = #{member_no}
        ]]>
    </select>

    <!-- 가입내역 교육자 목록 -->
    <select id="myjoinListEducator" resultType="GroupDTO">
        <![CDATA[
        SELECT m.member_name
        FROM
            groupmember gm
        JOIN
            game g ON gm.game_no = g.game_no
        JOIN
            studygroup sg ON gm.group_no = sg.group_no
        LEFT JOIN
        filegame fg ON gm.game_no = fg.game_no
        JOIN
        member m ON g.member_id = m.member_id
        WHERE gm.member_no = #{member_no}
        ]]>
    </select>
</mapper>